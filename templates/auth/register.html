{% extends 'layout.html' %}

{% block title %}Create Account{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <h4 class="card-title mb-1 fw-bold">Create your account</h4>
          <p class="text-muted small mb-4">Free forever · No credit card required</p>

          {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message | safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endwith %}

          <form method="POST" action="{{ url_for('auth.register') }}" novalidate id="registerForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input
                type="text"
                id="username"
                name="username"
                class="form-control"
                value="{{ username | default('') }}"
                placeholder="At least 3 characters"
                minlength="3"
                required
                autofocus
              >
              <div id="username-feedback" class="form-text"></div>
            </div>

            <div class="mb-3">
              <label for="email" class="form-label">Email address</label>
              <input
                type="email"
                id="email"
                name="email"
                class="form-control"
                value="{{ email | default('') }}"
                placeholder="you@example.com"
                required
              >
              <div id="email-feedback" class="form-text"></div>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                id="password"
                name="password"
                class="form-control"
                placeholder="At least 8 characters"
                minlength="8"
                required
              >
            </div>

            <div class="mb-4">
              <label for="confirm_password" class="form-label">Confirm Password</label>
              <input
                type="password"
                id="confirm_password"
                name="confirm_password"
                class="form-control"
                placeholder="Repeat your password"
                required
              >
              <div id="pw-match-feedback" class="form-text"></div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary" id="submitBtn">Create Account</button>
            </div>
          </form>

          <hr class="my-3">
          <p class="text-center small mb-0">
            Already have an account? <a href="{{ url_for('auth.login') }}">Sign in</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const usernameInput = document.getElementById('username');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const confirmInput = document.getElementById('confirm_password');
  const usernameFeedback = document.getElementById('username-feedback');
  const emailFeedback = document.getElementById('email-feedback');
  const pwFeedback = document.getElementById('pw-match-feedback');
  let usernameOk = false, emailOk = false;

  function debounce(fn, delay) {
    let timer;
    return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), delay); };
  }

  async function checkField(url, feedback, okFlag) {
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.available) {
        feedback.textContent = '✓ ' + data.message;
        feedback.className = 'form-text text-success';
        return true;
      } else {
        feedback.textContent = '✗ ' + data.message;
        feedback.className = 'form-text text-danger';
        return false;
      }
    } catch (e) {
      feedback.textContent = '';
      return true; // Don't block on network error
    }
  }

  usernameInput.addEventListener('input', debounce(async () => {
    const v = usernameInput.value.trim();
    if (v.length < 3) {
      usernameFeedback.textContent = 'Minimum 3 characters';
      usernameFeedback.className = 'form-text text-muted';
      usernameOk = false;
      return;
    }
    usernameOk = await checkField(
      `/auth/check-username?username=${encodeURIComponent(v)}`,
      usernameFeedback
    );
  }, 400));

  emailInput.addEventListener('input', debounce(async () => {
    const v = emailInput.value.trim();
    if (!v.includes('@')) {
      emailFeedback.textContent = '';
      emailOk = false;
      return;
    }
    emailOk = await checkField(
      `/auth/check-email?email=${encodeURIComponent(v)}`,
      emailFeedback
    );
  }, 400));

  confirmInput.addEventListener('input', () => {
    if (confirmInput.value === passwordInput.value) {
      pwFeedback.textContent = '✓ Passwords match';
      pwFeedback.className = 'form-text text-success';
    } else {
      pwFeedback.textContent = '✗ Passwords do not match';
      pwFeedback.className = 'form-text text-danger';
    }
  });
})();
</script>
{% endblock %}
