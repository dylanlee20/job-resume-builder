{% extends "layout.html" %}

{% block title %}Process Resume - NewWhale Career{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2>Resume Processing</h2>
                
                <div class="mb-4">
                    <strong>File:</strong> {{ resume.original_filename }}<br>
                    <strong>Status:</strong> 
                    {% if resume.status == 'parsed' %}
                        <span class="badge bg-success">Parsed Successfully</span>
                    {% elif resume.status == 'error' %}
                        <span class="badge bg-danger">Error</span>
                    {% else %}
                        <span class="badge bg-warning">{{ resume.status|title }}</span>
                    {% endif %}
                </div>
                
                {% if resume.status == 'parsed' %}
                    <div class="alert alert-success">
                        Your resume has been parsed successfully and is ready for assessment!
                    </div>
                    
                    <button class="btn btn-primary" id="assess-btn">
                        <i class="bi bi-stars"></i> Get Free Assessment
                    </button>
                    
                    <div id="assessment-result" class="mt-3" style="display: none;"></div>
                    
                {% elif resume.status == 'error' %}
                    <div class="alert alert-danger">
                        We couldn't parse your resume. Please ensure it contains readable text.
                    </div>
                    <a href="{{ url_for('resume.upload') }}" class="btn btn-secondary">Try Another Resume</a>
                {% endif %}
                
                <a href="{{ url_for('resume.history') }}" class="btn btn-outline-secondary mt-3">View History</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#assess-btn').click(function() {
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Assessing...');
        
        $.ajax({
            url: '{{ url_for("resume.assess", resume_id=resume.id) }}',
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            success: function(response) {
                if (response.success) {
                    window.location.href = '/resume/{{ resume.id }}/assessment/' + response.assessment_id;
                } else {
                    $('#assessment-result').show().html(
                        '<div class="alert alert-danger">' + response.message + '</div>'
                    );
                    $('#assess-btn').prop('disabled', false).html('<i class="bi bi-stars"></i> Get Free Assessment');
                }
            },
            error: function(xhr) {
                let message = 'Assessment failed. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                $('#assessment-result').show().html(
                    '<div class="alert alert-danger">' + message + '</div>'
                );
                $('#assess-btn').prop('disabled', false).html('<i class="bi bi-stars"></i> Get Free Assessment');
            }
        });
    });
});
</script>
{% endblock %}
